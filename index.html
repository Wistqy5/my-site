// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword, 
  signOut 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { 
  getDatabase, 
  ref, 
  set, 
  get 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// üîë –¢–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnZlKQV6BJLIo",
  authDomain: "scp-foundation-45b20.firebaseapp.com",
  databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com",
  projectId: "scp-foundation-45b20",
  storageBucket: "scp-foundation-45b20.firebasestorage.app",
  messagingSenderId: "383272466518",
  appId: "1:383272466518:web:3225b8911a56c9d769e3f7",
  measurementId: "G-G84NR3K9G2"
};

// init
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase(app);

// ------------ AUTH ------------
window.register = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCred.user.uid;
    // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å 1
    await set(ref(db, "users/" + uid), { level: 1 });
    alert("Registered! Default access level = 1");
  } catch (e) {
    alert(e.message);
  }
};

window.login = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
    alert("Logged in!");
    loadEntries();
  } catch (e) {
    alert(e.message);
  }
};

window.logout = function() {
  signOut(auth).then(() => {
    alert("Logged out!");
    document.getElementById("entries").innerHTML = "";
  });
};

// ------------ ENTRIES ------------
async function loadEntries() {
  const entriesDiv = document.getElementById("entries");
  entriesDiv.innerHTML = "";

  const user = auth.currentUser;
  if (!user) {
    entriesDiv.innerHTML = "<p>Please login</p>";
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ —é–∑–µ—Ä–∞
  const userSnap = await get(ref(db, "users/" + user.uid));
  let userLevel = 1;
  if (userSnap.exists()) {
    userLevel = userSnap.val().level || 1;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º SCP –∑–∞–ø–∏—Å–∏
  const scpSnap = await get(ref(db, "scp"));
  if (!scpSnap.exists()) {
    entriesDiv.innerHTML = "<p>No SCP entries in DB</p>";
    return;
  }

  scpSnap.forEach(child => {
    const data = child.val();
    const box = document.createElement("div");
    box.className = "scp-entry";

    if (userLevel >= data.requiredLevel) {
      box.innerHTML = `<h3>${data.title}</h3><p>${data.text}</p><small>Required Level: ${data.requiredLevel}</small>`;
    } else {
      box.innerHTML = `<h3>${data.title}</h3><p style="color:red">ACCESS DENIED</p><small>Required Level: ${data.requiredLevel}</small>`;
    }

    entriesDiv.appendChild(box);
  });
}
