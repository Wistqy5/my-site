<script>
  // ‚Äî‚Äî‚Äî –î–∞–Ω–Ω—ã–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî‚Äî‚Äî
  const DEFAULT_USERS = [
    { username: "admin",  password: "1234", role: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", level: 5 },
    { username: "bright", password: "scp",  role: "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å", level: 3 }
  ];

  let users = loadUsers();
  let currentUser = loadSession();

  let scpData = [
    { id: "SCP-096", level: 4, class: "–ï–≤–∫–ª–∏–¥", description: "–°—É—â–µ—Å—Ç–≤–æ, –≤–ø–∞–¥–∞—é—â–µ–µ –≤ —è—Ä–æ—Å—Ç—å –ø—Ä–∏ –≤–∑–≥–ª—è–¥–µ –Ω–∞ –ª–∏—Ü–æ." },
    { id: "SCP-173", level: 2, class: "–ï–≤–∫–ª–∏–¥", description: "–°—Ç–∞—Ç—É—è, —Å–ø–æ—Å–æ–±–Ω–∞—è –¥–≤–∏–≥–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –µ—ë –Ω–µ –≤–∏–¥—è—Ç." },
    { id: "SCP-682", level: 5, class: "–ö–µ—Ç–µ—Ä", description: "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ—É–Ω–∏—á—Ç–æ–∂–∞–µ–º–æ–µ —Å—É—â–µ—Å—Ç–≤–æ." }
  ];

  function loadUsers() {
    const raw = localStorage.getItem("scp_users");
    if (!raw) {
      localStorage.setItem("scp_users", JSON.stringify(DEFAULT_USERS));
      return [...DEFAULT_USERS];
    }
    try { return JSON.parse(raw); } catch { return [...DEFAULT_USERS]; }
  }
  function saveUsers() {
    localStorage.setItem("scp_users", JSON.stringify(users));
  }

  function loadSession() {
    const raw = localStorage.getItem("scp_session");
    try { return raw ? JSON.parse(raw) : null; } catch { return null; }
  }
  function saveSession(userOrNull) {
    if (userOrNull) localStorage.setItem("scp_session", JSON.stringify(userOrNull));
    else localStorage.removeItem("scp_session");
  }

  // ‚Äî‚Äî‚Äî UI ‚Äî‚Äî‚Äî
  function renderUI() {
    if (currentUser) {
      document.getElementById("auth").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      const profile = document.getElementById("profile");
      profile.innerHTML = `
        <div><strong>–ü—Ä–æ—Ñ–∏–ª—å:</strong> ${currentUser.username} | –£—Ä–æ–≤–µ–Ω—å: ${currentUser.level} | –†–æ–ª—å: ${currentUser.role}</div>
        <button onclick="logout()">–í—ã–π—Ç–∏</button>
      `;
      // –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
      const adminPanel = document.getElementById("admin-panel");
      if (currentUser.role === "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä") adminPanel.classList.remove("hidden");
      else adminPanel.classList.add("hidden");

      const createForm = document.getElementById("create-form");
      const hint = document.getElementById("create-hint");
      if (currentUser.level >= 3) {
        createForm.classList.remove("hidden");
        hint.textContent = "";
      } else {
        createForm.classList.add("hidden");
        hint.textContent = "–î–æ—Å—Ç—É–ø–Ω–æ —Å —É—Ä–æ–≤–Ω—è 3.";
      }

      renderSCPList();
    } else {
      document.getElementById("auth").classList.remove("hidden");
      document.getElementById("main").classList.add("hidden");
    }
  }

  function renderSCPList() {
    const query = document.getElementById("search").value.toLowerCase();
    const list = document.getElementById("scp-list");
    list.innerHTML = "";
    scpData
      .filter(scp => scp.id.toLowerCase().includes(query))
      .forEach(scp => {
        const link = document.createElement("a");
        link.className = "scp-link";
        link.href = "#";
        link.textContent = `${scp.id} ${lockBadge(scp.level)}`;
        link.onclick = () => openSCP(scp);
        list.appendChild(link);
      });
  }
  function lockBadge(level) {
    return `(L${level})`;
  }

  // ‚Äî‚Äî‚Äî –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî‚Äî‚Äî
  function login() {
    const name = document.getElementById("login-name").value.trim();
    const pass = document.getElementById("login-pass").value.trim();
    const remember = document.getElementById("remember-me").checked;

    const user = users.find(u => u.username === name && u.password === pass);
    if (!user) return alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");

    currentUser = { ...user };
    if (remember) saveSession(currentUser);
    else saveSession(null);
    renderUI();
  }

  function logout() {
    currentUser = null;
    saveSession(null);
    // –û—á–∏—Å—Ç–∏–º –ø–æ–ª—è –≤—Ö–æ–¥–∞
    document.getElementById("login-name").value = "";
    document.getElementById("login-pass").value = "";
    renderUI();
  }

  function toggleAuthMode() {
    const reg = document.getElementById("register-form");
    reg.classList.toggle("hidden");
  }

  function registerUser() {
    const name = document.getElementById("reg-name").value.trim();
    const pass = document.getElementById("reg-pass").value.trim();
    const role = document.getElementById("reg-role").value;

    if (!name || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å");
    if (users.some(u => u.username === name)) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");

    const newUser = { username: name, password: pass, role, level: 1 };
    users.push(newUser);
    saveUsers();
    alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.");
    // –°–≤–µ—Ä–Ω—ë–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById("register-form").classList.add("hidden");
    document.getElementById("login-name").value = name;
  }

  function openSCP(scp) {
    if (!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ");
    if (currentUser.level < scp.level) {
      alert("‚õî Access Denied: –£—Ä–æ–≤–µ–Ω—å –¥–æ–ø—É—Å–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω.");
      return;
    }
    const modal = document.getElementById("scp-modal");
    modal.innerHTML = `
      <h2>${scp.id}</h2>
      <p><strong>–ö–ª–∞—Å—Å:</strong> ${scp.class}</p>
      <p>${scp.description}</p>
      <button onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>`;
    document.getElementById("overlay").style.display = "block";
    modal.style.display = "block";
  }

  function closeModal() {
    document.getElementById("overlay").style.display = "none";
    document.getElementById("scp-modal").style.display = "none";
  }

  function createSCP() {
    if (!currentUser || currentUser.level < 3)
      return alert("‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SCP.");
    const id = document.getElementById("new-id").value.trim();
    const level = parseInt(document.getElementById("new-level").value);
    const cls = document.getElementById("new-class").value.trim();
    const desc = document.getElementById("new-desc").value.trim();
    if (!id || !cls || !desc || isNaN(level)) return alert("‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è.");
    if (level < 1 || level > 5) return alert("üö´ –£—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5.");
    scpData.push({ id, level, class: cls, description: desc });
    renderSCPList();
    // –û—á–∏—Å—Ç–∏–º —Ñ–æ—Ä–º—É
    document.getElementById("new-id").value = "";
    document.getElementById("new-level").value = "";
    document.getElementById("new-class").value = "";
    document.getElementById("new-desc").value = "";
  }

  function assignRole() {
    if (!currentUser || currentUser.role !== "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
      return alert("‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å —Ä–æ–ª–∏.");
    const name = document.getElementById("target-user").value.trim();
    const role = document.getElementById("target-role").value;
    const user = users.find(u => u.username === name);
    if (!user) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
    user.role = role;
    // –û–±–Ω–æ–≤–∏–º —É—Ä–æ–≤–µ–Ω—å, –µ—Å–ª–∏ –ø–æ–≤—ã—à–∞–µ–º –¥–æ –û5 (–ø—Ä–∏–º–µ—Ä: —É—Ä–æ–≤–µ–Ω—å 5)
    if (role === "–û5" && user.level < 5) user.level = 5;
    saveUsers();
    alert(`‚úÖ –†–æ–ª—å "${role}" –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${name}`);
  }

  // ‚Äî‚Äî‚Äî –ê–≤—Ç–æ–ª–æ–≥–∏–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî‚Äî‚Äî
  window.addEventListener("DOMContentLoaded", () => {
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è ‚Äî –∑–∞–Ω–æ–≤–æ –ø–æ–¥—Ç—è–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ (–Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–æ–ª–µ–π)
    if (currentUser) {
      const fresh = users.find(u => u.username === currentUser.username);
      currentUser = fresh ? { ...fresh } : null;
    }
    renderUI();
  });
</script>
