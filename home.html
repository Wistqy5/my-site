<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SCP Foundation</title>
  <style>
    :root{
      --bg:#111;
      --panel:#1b1b1b;
      --panel2:#222;
      --text:#eee;
      --muted:#b9b9b9;
      --accent:#666;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Arial, sans-serif;
      display:flex;
      height:100vh;
    }
    /* Сайдбар слева */
    #sidebar{
      width:260px;
      background:#1a1a1a;
      padding:16px;
      overflow-y:auto;
      border-right:1px solid #1f1f1f;
    }
    #sidebar h3{margin:4px 0 10px 0}
    #entries a.scp-entry{
      display:block;
      padding:6px 4px;
      margin:3px 0;
      color:#cfcfcf;
      text-decoration:none;
      border-radius:6px;
    }
    #entries a.scp-entry:hover{
      color:#fff;
      background:#232323;
      text-decoration:none;
    }

    /* Основная колонка — ограничиваем ширину и центрируем визуально */
    #content{
      flex:1;
      padding:24px;
      overflow-y:auto;
      display:flex;
      justify-content:center; /* чтобы не тянулось на всю ширину */
    }
    .container{
      width:100%;
      max-width:940px; /* главное ограничение ширины */
    }

    h1{margin:0 0 18px 0; font-weight:700}

    /* Карточки-секции */
    .card{
      background:var(--panel);
      border-radius:12px;
      padding:16px;
      margin:18px 0;
      box-shadow: inset 0 0 0 1px #202020;
    }
    .card h3{margin:0 0 12px 0}

    /* Поля ввода */
    input[type="text"],
    input[type="password"],
    select,
    textarea{
      width:100%;
      background:#0f0f0f;
      color:var(--text);
      border:1px solid #2a2a2a;
      border-radius:8px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    input::placeholder, textarea::placeholder{color:#8d8d8d}

    /* Кнопки — НЕ на 100% ширины */
    button{
      display:inline-block;
      padding:9px 14px;
      border-radius:9px;
      border:1px solid #2a2a2a;
      background:#2a2a2a;
      color:#fff;
      cursor:pointer;
      transition:background .15s, transform .02s;
    }
    button:hover{background:#3a3a3a}
    button:active{transform:translateY(1px)}

    /* Хедер пользователя */
    #userHeader{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    #userInfo{color:var(--muted)}
  </style>
</head>
<body>
  <!-- Сайдбар -->
  <aside id="sidebar">
    <h3>Поиск SCP</h3>
    <input type="text" id="search" placeholder="Поиск..." />
    <div id="entries" style="margin-top:10px;">Нет SCP записей</div>
  </aside>

  <!-- Контент -->
  <main id="content">
    <div class="container">
      <h1>☉ SCP Foundation</h1>

      <!-- Авторизация -->
      <div id="authSection" class="card">
        <h3>Вход</h3>
        <input type="text" id="nick" placeholder="Ник" />
        <input type="password" id="password" placeholder="Пароль" />
        <button onclick="login()">Войти</button>
      </div>

      <!-- Шапка пользователя + выход -->
      <div id="userHeader" class="card" style="display:none;">
        <div>
          <div><strong id="helloNick"></strong></div>
          <div id="userInfo"></div>
        </div>
        <div>
          <button id="logoutBtn" onclick="logout()">Выход</button>
        </div>
      </div>

      <!-- Создать SCP -->
      <div id="createSCP" class="card" style="display:none;">
        <h3>Создать SCP</h3>
        <input type="text" id="scpTitle" placeholder="Название SCP" />
        <textarea id="scpContent" placeholder="Описание SCP"></textarea>
        <label>Минимальный уровень доступа:</label>
        <select id="scpLevel">
          <option value="1">Level 1</option>
          <option value="2">Level 2</option>
          <option value="3">Level 3</option>
          <option value="4">Level 4</option>
          <option value="5">Level 5</option>
        </select>
        <div style="margin-top:6px;">
          <button onclick="createSCPEntry()">Добавить SCP</button>
        </div>
      </div>

      <!-- Админ панель -->
      <div id="adminPanel" class="card" style="display:none;">
        <h3>Административная панель</h3>
        <input type="text" id="targetNick" placeholder="Ник пользователя" />
        <label>Новый уровень:</label>
        <select id="newLevel">
          <option value="1">Level 1</option>
          <option value="2">Level 2</option>
          <option value="3">Level 3</option>
          <option value="4">Level 4</option>
          <option value="5">Level 5</option>
        </select>
        <label>Роль:</label>
        <select id="newRole">
          <option value="Researcher">Researcher</option>
          <option value="Security">Security</option>
          <option value="MTF">MTF</option>
          <option value="Administrator">Administrator</option>
          <option value="O5">O5 Council</option>
        </select>
        <div style="margin-top:6px;">
          <button onclick="updateUser()">Обновить</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase + логика -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnZlKQV6BJLIo",
      authDomain: "scp-foundation-45b20.firebaseapp.com",
      databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com/",
      projectId: "scp-foundation-45b20",
      storageBucket: "scp-foundation-45b20.firebasestorage.app",
      messagingSenderId: "383272466518",
      appId: "1:383272466518:web:3225b8911a56c9d769e3f7",
      measurementId: "G-G84NR3K9G2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = null;
    let userLevel = 0;
    let userRole = "Researcher";

    async function login(){
      const nick = document.getElementById("nick").value.trim();
      const pass = document.getElementById("password").value.trim();
      if(!nick || !pass){ alert("Введите ник и пароль!"); return; }

      try{
        const snap = await get(ref(db, "users/" + nick));
        if(!snap.exists()){ alert("Нет такого пользователя!"); return; }
        const data = snap.val();
        if((data.password||"") !== pass){ alert("Неверный пароль!"); return; }

        currentUser = nick;
        userLevel = data.level || 1;
        userRole = data.role || "Researcher";

        // UI переключение
        document.getElementById("authSection").style.display = "none";
        document.getElementById("userHeader").style.display = "flex";
        document.getElementById("helloNick").textContent = `Добро пожаловать, ${nick}`;
        document.getElementById("userInfo").textContent = `Уровень: ${userLevel} • Роль: ${userRole}`;

        document.getElementById("createSCP").style.display = userLevel >= 3 ? "block" : "none";
        document.getElementById("adminPanel").style.display  = userLevel >= 4 ? "block" : "none";

        loadEntries();
      }catch(e){
        console.error(e);
        alert("Ошибка подключения к базе.");
      }
    }

    function logout(){
      currentUser=null;
      userLevel=0;
      userRole="Researcher";
      document.getElementById("authSection").style.display = "block";
      document.getElementById("userHeader").style.display  = "none";
      document.getElementById("createSCP").style.display = "none";
      document.getElementById("adminPanel").style.display  = "none";
      document.getElementById("entries").textContent = "Нет SCP записей";
      (document.getElementById("search").value = "");
    }

    async function updateUser(){
      const nick = document.getElementById("targetNick").value.trim();
      const level = parseInt(document.getElementById("newLevel").value);
      const role  = document.getElementById("newRole").value;

      if(!nick){ alert("Введите ник пользователя!"); return; }
      try{
        const snap = await get(ref(db, "users/" + nick));
        if(!snap.exists()){ alert("Пользователь не найден!"); return; }

        await update(ref(db, "users/" + nick), { level, role });
        alert(`Пользователь ${nick} обновлён: Level ${level}, Role ${role}`);
      }catch(e){
        console.error(e); alert("Ошибка при обновлении пользователя.");
      }
    }

    async function createSCPEntry(){
      const title = document.getElementById("scpTitle").value.trim();
      const content = document.getElementById("scpContent").value.trim();
      const requiredLevel = parseInt(document.getElementById("scpLevel").value);

      if(!title || !content){ alert("Заполните все поля!"); return; }
      try{
        const newRef = push(ref(db, "scp"));
        await set(newRef, { title, content, requiredLevel, author: currentUser });
        document.getElementById("scpTitle").value = "";
        document.getElementById("scpContent").value = "";
        alert("SCP создан!");
        loadEntries();
      }catch(e){
        console.error(e); alert("Ошибка при создании SCP.");
      }
    }

    async function loadEntries(){
      try{
        const snap = await get(ref(db, "scp"));
        const list = document.getElementById("entries");
        list.innerHTML = "";
        if(!snap.exists()){ list.textContent = "Нет SCP записей"; return; }

        snap.forEach(cs=>{
          const d = cs.val();
          const a = document.createElement("a");
          a.className = "scp-entry";
          a.href = `scp.html?id=${cs.key}`;
          a.textContent = `${d.title} (Level ${d.requiredLevel})`;
          list.appendChild(a);
        });

        // поиск
        const input = document.getElementById("search");
        input.oninput = function(){
          const q = this.value.toLowerCase();
          Array.from(list.children).forEach(a=>{
            a.style.display = a.textContent.toLowerCase().includes(q) ? "block" : "none";
          });
        };
      }catch(e){
        console.error(e);
        document.getElementById("entries").textContent = "Ошибка загрузки SCP записей";
      }
    }

    // делаем функции доступными кнопкам
    window.login = login;
    window.logout = logout;
    window.updateUser = updateUser;
    window.createSCPEntry = createSCPEntry;
  </script>
</body>
</html>
