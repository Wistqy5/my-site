<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCP Foundation Intranet</title>
  <script type="module">
    // ✅ Firebase импорт
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, updateDoc, addDoc } 
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnЗlKQV6BJLIo",
      authDomain: "scp-foundation-45b20.firebaseapp.com",
      databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com/",
      projectId: "scp-foundation-45b20",
      storageBucket: "scp-foundation-45b20.appspot.com",
      messagingSenderId: "383272466518",
      appId: "1:383272466518:web:3225b8911a56c9d769e3f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === Пользователь из localStorage ===
    let currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) {
      window.location.href = "index.html"; // если нет логина
    }

    // === Вывод информации о пользователе ===
    async function loadUserInfo() {
      let userRef = doc(db, "users", currentUser.nick);
      let snap = await getDoc(userRef);

      if (snap.exists()) {
        let data = snap.data();
        document.getElementById("userInfo").innerHTML = `
          <div><strong>Ник:</strong> ${currentUser.nick}</div>
          <div><strong>Уровень:</strong> ${data.level}</div>
          <div><strong>Роль:</strong> ${data.role}</div>
          <div><strong>Сайт:</strong> ${data.site}</div>
        `;

        // админка видна админу и O5
        if (data.role === "O5" || data.role === "The Administrator") {
          document.getElementById("adminPanel").style.display = "block";
          document.getElementById("addScpPanel").style.display = "block";
        }
      }
    }

    // === Добавить SCP ===
    async function addScp() {
      let title = document.getElementById("scpTitle").value.trim();
      let level = document.getElementById("scpLevel").value.trim();
      let content = document.getElementById("scpContent").value.trim();

      if (!title || !level || !content) {
        alert("Заполните все поля!");
        return;
      }

      let date = getCurrentDate();
      await addDoc(collection(db, "scp"), {
        title, level, content, date
      });

      loadScps();

      document.getElementById("scpTitle").value = "";
      document.getElementById("scpLevel").value = "";
      document.getElementById("scpContent").value = "";
    }

    // === Загрузить SCP ===
    async function loadScps() {
      document.getElementById("entries").innerHTML = "";
      let query = await getDocs(collection(db, "scp"));
      query.forEach(docu => {
        let scp = docu.data();
        let entry = document.createElement("div");
        entry.className = "scp-entry";
        entry.innerHTML = `<strong>${scp.title}</strong> (Ур.${scp.level}) 
                           <small class="date-tag">[${scp.date}]</small>`;
        entry.onclick = () => alert(scp.content);
        document.getElementById("entries").appendChild(entry);
      });
    }

    // === Обновить пользователя (админ) ===
    async function updateUser() {
      let nick = document.getElementById("targetNick").value.trim();
      let newLevel = document.getElementById("newLevel").value;
      let newRole = document.getElementById("newRole").value;
      let newSite = document.getElementById("newSite").value;

      if (!nick) return alert("Введите ник!");

      let userRef = doc(db, "users", nick);
      await updateDoc(userRef, {
        level: newLevel,
        role: newRole,
        site: newSite
      });

      alert("Обновлено!");
    }

    // === Дата ===
    function getCurrentDate() {
      const d = new Date();
      return `${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getFullYear()} | ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    }

    // === Выход ===
    function logout() {
      localStorage.removeItem("currentUser");
      window.location.href = "index.html";
    }

    // === Запуск ===
    window.addEventListener("DOMContentLoaded", () => {
      loadUserInfo();
      loadScps();
      window.addScp = addScp;
      window.updateUser = updateUser;
      window.logout = logout;
    });
  </script>
  <style>
    /* сюда твои стили (из того, что ты скинул выше) */
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>SCP Files</h3>
    <input type="text" id="search" placeholder="Поиск...">
    <div id="entries">Нет SCP записей</div>
  </div>

  <div id="content">
    <h1><img id="logo" src="logo.png" alt="">Secure Contain Protect</h1>

    <div id="userInfo"></div>
    <button id="logoutBtn" onclick="logout()">Выход</button>

    <div id="adminPanel" class="panel" style="display:none;">
      <h3>Административная панель</h3>
      <input type="text" id="targetNick" placeholder="Ник пользователя">
      <label>Новый уровень:</label>
      <select id="newLevel">
        <option value="0">Level 0</option>
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
        <option value="4">Level 4</option>
        <option value="5">Level 5</option>
        <option value="6">Level Omni</option>
        <option value="7">Level Omni+</option>
      </select>
      <label>Роль:</label>
      <select id="newRole">
        <option value="Class-D">Class-D</option>
        <option value="Researcher">Researcher</option>
        <option value="Security Department">Security Department</option>
        <option value="Mobile Task Force">Mobile Task Force</option>
        <option value="Administrative Department">Administrative Department</option>
        <option value="O5">O5 Council</option>
        <option value="The Administrator">The Administrator</option>
        <option value="Office of The Administrator">Office of The Administrator</option>
      </select>
      <label>Сайт:</label>
      <select id="newSite">
        <option value="Site-01">Site-01</option>
        <option value="Site-17">Site-17</option>
        <option value="Site-82">Site-82</option>
        <option value="Site-██">Site-██</option>
      </select>
      <button onclick="updateUser()">Обновить</button>
    </div>

    <div id="addScpPanel" class="panel" style="display:none;">
      <h3>Добавить SCP</h3>
      <input type="text" id="scpTitle" placeholder="Название SCP">
      <input type="number" id="scpLevel" placeholder="Требуемый уровень">
      <textarea id="scpContent" placeholder="Описание"></textarea>
      <button onclick="addScp()">Добавить</button>
    </div>
  </div>
</body>
</html>
