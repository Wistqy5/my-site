<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCP Foundation Intranet</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {margin:0;display:flex;height:100vh;font-family:"Segoe UI",sans-serif;background:#0b0b0b;color:#f2f2f2;}
    h1,h3{margin:0;font-weight:500;} h1{font-size:28px;} h3{font-size:18px;margin-bottom:12px;}
    #sidebar{width:280px;background:#111;border-right:3px solid #c62828;padding:20px;box-sizing:border-box;display:flex;flex-direction:column;}
    #sidebar h3{border-bottom:1px solid #333;padding-bottom:6px;}
    #search{margin:12px 0;padding:10px;border:1px solid #444;border-radius:6px;background:#1b1b1b;color:#eee;}
    #entries{flex:1;overflow-y:auto;}
    .scp-entry{display:block;padding:10px;margin:6px 0;border-radius:6px;text-decoration:none;color:#ccc;background:#181818;transition:.2s;}
    .scp-entry:hover{background:#c62828;color:white;}
    #content{flex:1;padding:30px;overflow-y:auto;}
    #logo{width:36px;height:36px;margin-right:10px;vertical-align:-8px;}
    #userInfo{background:#161616;padding:20px;border-radius:10px;margin:20px 0;box-shadow:0 0 20px rgba(0,0,0,.4);line-height:1.6;}
    .panel{background:#161616;padding:20px;border-radius:10px;margin-bottom:24px;box-shadow:0 0 15px rgba(0,0,0,.3);}
    input,select,textarea{width:100%;padding:10px;margin:10px 0 16px;border:1px solid #333;border-radius:8px;background:#0d0d0d;color:#f5f5f5;}
    button{padding:12px;width:100%;border:0;border-radius:8px;font-weight:600;cursor:pointer;background:#c62828;color:#fff;transition:.2s;}
    button:hover{background:#e53935;} #logoutBtn{background:#444;margin-bottom:16px;} #logoutBtn:hover{background:#666;}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <h3>База SCP</h3>
    <input type="text" id="search" placeholder="Поиск...">
    <div id="entries">Загрузка…</div>
  </div>

  <!-- Main content -->
  <div id="content">
    <h1><img id="logo" src="logo.png" alt="">SCP Foundation</h1>
    <div id="userInfo"></div>
    <button id="logoutBtn" onclick="logout()">Выйти</button>

    <!-- Admin -->
    <div id="adminPanel" class="panel" style="display:none;">
      <h3>Административная панель</h3>
      <input type="text" id="targetNick" placeholder="Ник пользователя">
      <label>Новый уровень:</label>
      <select id="newLevel"></select>
      <label>Роль:</label>
      <select id="newRole"></select>
      <div id="unitDiv" style="display:none;">
        <label>Подразделение:</label>
        <select id="newUnit"></select>
      </div>
      <label>Сайт:</label>
      <select id="newSite">
        <option>Site-01</option><option>Site-17</option><option>Site-19</option><option>Site-82</option><option>Site-██</option>
      </select>
      <button onclick="updateUser()">Обновить</button>
    </div>

    <!-- Stats -->
    <div id="statsPanel" class="panel" style="display:none;">
      <h3>Просмотр статистики</h3>
      <input type="text" id="statsNick" placeholder="Ник пользователя">
      <button onclick="showStats()">Показать</button>
      <div id="userStats"></div>
    </div>

    <!-- Add SCP -->
    <div id="addScpPanel" class="panel" style="display:none;">
      <h3>Добавить SCP-запись</h3>
      <input type="text" id="scpTitle" placeholder="Название SCP">
      <input type="number" id="scpLevel" placeholder="Требуемый уровень">
      <textarea id="scpContent" placeholder="Описание"></textarea>
      <button onclick="addScp()">Добавить</button>
    </div>
  </div>

<script>
  // === Firebase init ===
  const firebaseConfig = {
    apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnЗlKQV6BJLIo",
    authDomain: "scp-foundation-45b20.firebaseapp.com",
    databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com/",
    projectId: "scp-foundation-45b20",
    storageBucket: "scp-foundation-45b20.appspot.com",
    messagingSenderId: "383272466518",
    appId: "1:383272466518:web:3225b8911a56c9d769e3f7"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const LEVELS = ["none","0","-1","1","1+","2","2+","3","3+","4","4+","5","5+","6","7"];
  const ROLES = [
    "Класс-Д","Группа Быстрого Реагирования","Медицинский Департамент",
    "Служба Разведки","Инжинерно-Техническая Служба","Отдел Внешних Связей",
    "Служба Внутреннего Трибунала","Комитет по Этике","Отдел Внутренней Безопасности",
    "Научный Департамент Специализированных Исследований","Служба Безопасности",
    "Мобильные Оперативные Группы","Административный Департамент",
    "Член Совета O5","The Administrator","Office of The Administrator"
  ];
  const UNITS = {
    "Научный Департамент Специализированных Исследований":["Jr Researcher","Researcher","Sr Researcher","Head Researcher"],
    "Служба Безопасности":["Cadet","Guard","Sr Guard","Captain"],
    "Мобильные Оперативные Группы":["Operative","Specialist","Commander"],
    "Член Совета O5":["O5-1","O5-2","O5-3","O5-4","O5-5","O5-6","O5-7","O5-8","O5-9","O5-10","O5-11","O5-12","O5-13"]
  };

  let currentUserData=null;

  // === Auth check ===
  auth.onAuthStateChanged(user=>{
    if(!user){location.href="index.html";return;}
    db.ref("users/"+user.uid).once("value").then(snap=>{
      currentUserData=snap.val();
      renderUserInfo();
      renderEntries();
      setupPanels();
    });
  });

  function renderUserInfo(){
    document.getElementById("userInfo").innerHTML=`
      <b>Ник:</b> ${currentUserData.nick}<br>
      <b>Уровень:</b> ${currentUserData.level}<br>
      <b>Роль:</b> ${currentUserData.role}<br>
      <b>Подразделение:</b> ${currentUserData.unit||"-"}<br>
      <b>Сайт:</b> ${currentUserData.site||"-"}
    `;
  }

  function setupPanels(){
    // уровни
    LEVELS.forEach(l=>{let o=document.createElement("option");o.value=l;o.text=l;document.getElementById("newLevel").appendChild(o);});
    // роли
    ROLES.forEach(r=>{let o=document.createElement("option");o.value=r;o.text=r;document.getElementById("newRole").appendChild(o);});
    document.getElementById("newRole").addEventListener("change",()=>{
      let role=document.getElementById("newRole").value;
      let unitDiv=document.getElementById("unitDiv");
      let unitSel=document.getElementById("newUnit");
      unitSel.innerHTML="";
      if(UNITS[role]){
        UNITS[role].forEach(u=>{let o=document.createElement("option");o.value=u;o.text=u;unitSel.appendChild(o);});
        unitDiv.style.display="block";
      } else unitDiv.style.display="none";
    });

    if(["6","7"].includes(currentUserData.level)) document.getElementById("adminPanel").style.display="block";
    if(parseInt(currentUserData.level)>=4) document.getElementById("statsPanel").style.display="block";
    if(["6","7"].includes(currentUserData.level)) document.getElementById("addScpPanel").style.display="block";
  }

  function renderEntries(){
    db.ref("scp").on("value",snap=>{
      let list=document.getElementById("entries");
      list.innerHTML="";
      snap.forEach(s=>{
        let e=s.val();
        if(parseInt(currentUserData.level)>=parseInt(e.level)){
          let a=document.createElement("a");
          a.className="scp-entry";
          a.textContent=e.title;
          a.href="#";
          a.onclick=()=>alert("["+e.title+"]\n"+e.content);
          list.appendChild(a);
        }
      });
    });
  }

  function addScp(){
    let title=document.getElementById("scpTitle").value;
    let level=document.getElementById("scpLevel").value;
    let content=document.getElementById("scpContent").value;
    if(!title||!content) return alert("Заполните поля");
    db.ref("scp").push({title,level,content});
    alert("Добавлено!");
  }

  function updateUser(){
    let nick=document.getElementById("targetNick").value;
    if(!nick) return alert("Введите ник");
    db.ref("users").orderByChild("nick").equalTo(nick).once("value",snap=>{
      if(!snap.exists()) return alert("Нет такого пользователя");
      snap.forEach(u=>{
        let updates={
          level:document.getElementById("newLevel").value,
          role:document.getElementById("newRole").value,
          site:document.getElementById("newSite").value
        };
        if(UNITS[updates.role]) updates.unit=document.getElementById("newUnit").value;
        db.ref("users/"+u.key).update(updates);
        alert("Обновлено!");
      });
    });
  }

  function showStats(){
    let nick=document.getElementById("statsNick").value;
    db.ref("users").orderByChild("nick").equalTo(nick).once("value",snap=>{
      if(!snap.exists()) return alert("Нет такого");
      snap.forEach(u=>{
        let d=u.val();
        document.getElementById("userStats").innerHTML=`
          <b>Ник:</b> ${d.nick}<br>
          <b>Уровень:</b> ${d.level}<br>
          <b>Роль:</b> ${d.role}<br>
          <b>Подразделение:</b> ${d.unit||"-"}<br>
          <b>Сайт:</b> ${d.site||"-"}
        `;
      });
    });
  }

  function logout(){auth.signOut();}
  window.addScp=addScp;window.updateUser=updateUser;window.showStats=showStats;window.logout=logout;
</script>
</body>
</html>
