<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCP Foundation DB - –ì–ª–∞–≤–Ω–∞—è</title>
  <style>
    body { background:#111; color:#eee; font-family:Arial; display:flex; margin:0; }
    #sidebar { width:280px; background:#1a1a1a; padding:15px; min-height:100vh; }
    #content { flex:1; padding:20px; text-align:left; }
    .scp-entry { display:block; margin:3px 0; color:#4da6ff; text-decoration:none; }
    .scp-entry:hover { text-decoration:underline; }
    input,button,select,textarea { margin:5px 0; padding:6px; border:none; border-radius:4px; }
    button { background:#222; color:white; cursor:pointer; }
    button:hover { background:#444; }
    #createBtn { position:fixed; bottom:20px; right:20px; padding:10px 15px; border-radius:50%; width:48px; height:48px; font-size:22px; line-height:26px; }
    #header { display:flex; align-items:center; margin-bottom:20px; }
    #header img { width:40px; height:40px; margin-right:10px; }
    #userMgmt { margin-top:25px; background:#1a1a1a; padding:12px; border-radius:8px; display:none; }
    #userMgmt h3 { margin:0 0 10px 0; }
    small.muted { color:#aaa; display:block; margin-top:4px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>üîé –ü–æ–∏—Å–∫ SCP</h3>
    <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫...">
    <div id="entries"></div>
  </div>

  <div id="content">
    <div id="header">
      <!-- –ü–æ–ª–æ–∂–∏ —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Ä—è–¥–æ–º —Å —Ñ–∞–π–ª–æ–º: scp_logo.png –∏–ª–∏ images/scp_logo.png -->
      <img src="scp_logo.png" alt="SCP Logo" onerror="this.style.display='none'">
      <h1>SCP Foundation</h1>
    </div>

    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b id="userNick"></b></p>
    <p>–í–∞—à —É—Ä–æ–≤–µ–Ω—å: <b id="userLevel"></b> | –†–æ–ª—å: <b id="userRole"></b></p>
    <button onclick="logout()">–í—ã—Ö–æ–¥</button>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ Level >= 4) -->
    <div id="userMgmt">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
      <label>–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
      <input type="text" id="mgmtNick" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: bright">

      <label>–ù–æ–≤–∞—è —Ä–æ–ª—å</label>
      <select id="newRole">
        <option>–ü–µ—Ä—Å–æ–Ω–∞–ª D</option>
        <option>–û—Ö—Ä–∞–Ω–∞</option>
        <option>–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å</option>
        <option>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
        <option>O5</option>
      </select>

      <label>–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å</label>
      <select id="newLevel">
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
        <option value="4">Level 4</option>
        <option value="5">Level 5</option>
      </select>

      <button id="applyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <small class="muted">–ü—Ä–∞–≤–∏–ª–∞: Level 4 –Ω–µ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Ä–æ–≤–Ω–µ–º ‚â• 4 –∏ –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å Level 5.</small>
      <div id="mgmtMsg"></div>
    </div>
  </div>

  <button id="createBtn" title="–°–æ–∑–¥–∞—Ç—å SCP" onclick="createSCP()">+</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, push, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnZlKQV6BJLIo",
      authDomain: "scp-foundation-45b20.firebaseapp.com",
      databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com",
      projectId: "scp-foundation-45b20",
      storageBucket: "scp-foundation-45b20.appspot.com",
      messagingSenderId: "383272466518",
      appId: "1:383272466518:web:3225b8911a56c9d769e3f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const nick = localStorage.getItem("nick");
    const userLevel = Number(localStorage.getItem("level") || 1);
    const userRole  = localStorage.getItem("role") || "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å";
    if (!nick) window.location.href = "index.html";

    document.getElementById("userNick").innerText = nick;
    document.getElementById("userLevel").innerText = userLevel;
    document.getElementById("userRole").innerText  = userRole;

    // –ø–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ Level >= 4
    if (userLevel >= 4) {
      document.getElementById("userMgmt").style.display = "block";
    }

    function roleDefaultLevel(role){
      switch(role){
        case "O5": return 5;
        case "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä": return 4;
        case "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å": return 3;
        case "–û—Ö—Ä–∞–Ω–∞": return 2;
        default: return 1; // –ü–µ—Ä—Å–æ–Ω–∞–ª D
      }
    }

    // –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (–º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é)
    document.getElementById("newRole").addEventListener("change", (e)=>{
      document.getElementById("newLevel").value = String(roleDefaultLevel(e.target.value));
    });

    async function loadEntries() {
      const snap = await get(ref(db, "scp"));
      const entriesDiv = document.getElementById("entries");
      entriesDiv.innerHTML = "";

      if (!snap.exists()) {
        entriesDiv.innerHTML = "–ù–µ—Ç SCP –∑–∞–ø–∏—Å–µ–π";
        return;
      }

      snap.forEach(child => {
        const data = child.val();
        const link = document.createElement("a");
        link.href = `scp.html?id=${child.key}`;
        link.className = "scp-entry";
        link.innerText = data.title;  // –Ω–∞–ø—Ä–∏–º–µ—Ä: "SCP-001"
        entriesDiv.appendChild(link);
      });
    }

    function createSCP() {
      const title = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ SCP (–Ω–∞–ø—Ä–∏–º–µ—Ä SCP-001):");
      if (!title) return;
      const text = prompt("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç SCP:") || "";
      const level = Number(prompt("–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (1-5):") || 1);

      const scpRef = push(ref(db, "scp"));
      set(scpRef, { title, text, requiredLevel: level, author: nick }).then(() => {
        loadEntries();
        // –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–ø–∏—Å–∏:
        // window.location.href = `scp.html?id=${scpRef.key}`;
      });
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    // –ü–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É
    document.getElementById("search").addEventListener("input", e => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll(".scp-entry").forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(q) ? "block" : "none";
      });
    });

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (Level >= 4)
    document.getElementById("applyBtn").addEventListener("click", async ()=>{
      if (userLevel < 4) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");

      const tNick = document.getElementById("mgmtNick").value.trim();
      const nRole = document.getElementById("newRole").value;
      const nLevel = Number(document.getElementById("newLevel").value);
      const msgBox = document.getElementById("mgmtMsg");

      msgBox.innerText = "";

      if (!tNick) { alert("–£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫"); return; }

      const snap = await get(ref(db, "users/" + tNick));
      if (!snap.exists()) { alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }
      const target = snap.val();
      const targetLevel = Number(target.level || 1);

      // –ü—Ä–∞–≤–∏–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è Level 4
      if (userLevel === 4) {
        if (targetLevel >= 4) { alert("–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Ä–æ–≤–Ω–µ–º ‚â• 4"); return; }
        if (nLevel > 4) { alert("–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ 4"); return; }
      }

      await update(ref(db, "users/" + tNick), { level: nLevel, role: nRole });

      // –µ—Å–ª–∏ –º–µ–Ω—è–µ–º —Å–∞–º–∏ —Å–µ–±–µ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º localStorage –∏ UI
      if (tNick === nick) {
        localStorage.setItem("level", String(nLevel));
        localStorage.setItem("role", nRole);
        document.getElementById("userLevel").innerText = nLevel;
        document.getElementById("userRole").innerText  = nRole;
      }

      msgBox.style.color = "#7CFC00";
      msgBox.innerText = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${tNick} ‚Üí ${nRole} (Level ${nLevel})`;
    });

    loadEntries();

    window.logout = logout;
    window.createSCP = createSCP;
  </script>
</body>
</html>
