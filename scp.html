<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCP Foundation - Просмотр</title>
  <style>
    body { background:#111; color:#eee; font-family:Arial; padding:20px; }
    button { margin:5px; padding:6px 10px; border:none; border-radius:4px; background:#222; color:white; cursor:pointer; }
    button:hover { background:#444; }
    textarea { width:100%; height:150px; display:none; background:#1a1a1a; color:#eee; border:none; border-radius:5px; padding:10px; }
    .muted { color:#aaa; }
  </style>
</head>
<body>
  <h1 id="scpTitle"></h1>
  <div class="muted" id="meta"></div>
  <div id="scpContent" style="margin-top:10px;"></div>
  <textarea id="editText"></textarea><br>
  <button id="saveEditBtn" onclick="saveEdit()" style="display:none;">Сохранить</button>
  <button id="deleteBtn" onclick="deleteSCP()" style="display:none;">Удалить</button>
  <button onclick="window.location.href='home.html'">Назад</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnZlKQV6BJLIo",
      authDomain: "scp-foundation-45b20.firebaseapp.com",
      databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com",
      projectId: "scp-foundation-45b20",
      storageBucket: "scp-foundation-45b20.appspot.com",
      messagingSenderId: "383272466518",
      appId: "1:383272466518:web:3225b8911a56c9d769e3f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const scpId = urlParams.get("id");

    const nick = localStorage.getItem("nick");
    const userLevel = Number(localStorage.getItem("level") || 1);
    const userRole  = localStorage.getItem("role") || "Исследователь";
    if (!nick) window.location.href = "index.html";

    let current = null;

    async function loadSCP() {
      const snap = await get(ref(db, "scp/" + scpId));
      if (!snap.exists()) {
        document.getElementById("scpContent").innerHTML = "<p style='color:red'>Такого SCP не существует</p>";
        return;
      }

      current = snap.val();
      document.getElementById("scpTitle").innerText = current.title;
      document.getElementById("meta").innerText = `Автор: ${current.author || "неизвестно"} | Требуемый уровень: ${current.requiredLevel}`;

      if (userLevel >= Number(current.requiredLevel)) {
        document.getElementById("scpContent").innerText = current.text || "";

        if ((current.author === nick && userLevel >= 3) || userLevel >= 4) {
          document.getElementById("editText").style.display = "block";
          document.getElementById("editText").value = current.text || "";
          document.getElementById("saveEditBtn").style.display = "inline";
          document.getElementById("deleteBtn").style.display = "inline";
        }
      } else {
        document.getElementById("scpContent").innerHTML = "<p style='color:red'>ACCESS DENIED</p>";
      }
    }

    async function saveEdit() {
      const newText = document.getElementById("editText").value;
      await update(ref(db, "scp/" + scpId), { text: newText });
      alert("Изменения сохранены!");
      loadSCP();
    }

    async function deleteSCP() {
      if (!confirm("Удалить SCP?")) return;
      await remove(ref(db, "scp/" + scpId));
      alert("Удалено!");
      window.location.href = "home.html";
    }

    loadSCP();

    window.saveEdit = saveEdit;
    window.deleteSCP = deleteSCP;
  </script>
</body>
</html>
