<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCP Document</title>
  <style>
    body { background:#0d0d0d; color:#f0f0f0; font-family:Arial; padding:20px; }
    #scpContainer { max-width:600px; margin:auto; }
    .hidden { display:none; }
    button { margin:5px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#333; color:white; }
    button:hover { background:#555; }
    textarea, input, select { width:100%; margin:5px 0; padding:6px; background:#1a1a1a; border:1px solid #444; color:#f0f0f0; }
  </style>
</head>
<body>
  <a href="index.html" style="color:#0ff;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
  <div id="scpContainer">
    <h1 id="scpTitle"></h1>
    <p id="scpText"></p>
    <p><b>–¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:</b> <span id="scpLevel"></span></p>
    <p><b>–ê–≤—Ç–æ—Ä:</b> <span id="scpAuthor"></span></p>

    <div id="editSection" class="hidden">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SCP</h3>
      <input type="text" id="editTitle">
      <textarea id="editText"></textarea>
      <select id="editLevel">
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
        <option value="4">Level 4</option>
        <option value="5">Level 5</option>
      </select><br>
      <button onclick="saveEdit()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="cancelEdit()">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="actionBtns" class="hidden">
      <button onclick="showEdit()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button onclick="deleteSCP()">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, remove, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // üîë Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnZlKQV6BJLIo",
      authDomain: "scp-foundation-45b20.firebaseapp.com",
      databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com",
      projectId: "scp-foundation-45b20",
      storageBucket: "scp-foundation-45b20.appspot.com",
      messagingSenderId: "383272466518",
      appId: "1:383272466518:web:3225b8911a56c9d769e3f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- –ü–æ–ª—É—á–µ–Ω–∏–µ ID –∏–∑ URL ----------
    const urlParams = new URLSearchParams(window.location.search);
    const scpId = urlParams.get("id");

    const userData = JSON.parse(localStorage.getItem("currentUser")) || null;
    let currentSCP = null;

    async function loadSCP() {
      if (!scpId) {
        document.getElementById("scpContainer").innerHTML = "<h2>‚ùå SCP –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>";
        return;
      }

      const snap = await get(ref(db, "scp/" + scpId));
      if (!snap.exists()) {
        document.getElementById("scpContainer").innerHTML = "<h2>‚ùå SCP –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</h2>";
        return;
      }

      const data = snap.val();
      currentSCP = data;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
      if (!userData || userData.level < data.requiredLevel) {
        document.getElementById("scpContainer").innerHTML = "<h2 style='color:red'>ACCESS DENIED</h2>";
        return;
      }

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.getElementById("scpTitle").innerText = data.title;
      document.getElementById("scpText").innerText = data.text;
      document.getElementById("scpLevel").innerText = data.requiredLevel;
      document.getElementById("scpAuthor").innerText = data.author;

      // –î–æ—Å—Ç—É–ø –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ —É–¥–∞–ª–µ–Ω–∏—é
      if (userData && (userData.nick === data.author || userData.level >= 4)) {
        document.getElementById("actionBtns").classList.remove("hidden");
      }
    }

    // ---------- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ----------
    function showEdit() {
      document.getElementById("editSection").classList.remove("hidden");
      document.getElementById("editTitle").value = currentSCP.title;
      document.getElementById("editText").value = currentSCP.text;
      document.getElementById("editLevel").value = currentSCP.requiredLevel;
    }

    function cancelEdit() {
      document.getElementById("editSection").classList.add("hidden");
    }

    async function saveEdit() {
      const newData = {
        title: document.getElementById("editTitle").value,
        text: document.getElementById("editText").value,
        requiredLevel: parseInt(document.getElementById("editLevel").value),
        author: currentSCP.author
      };

      await update(ref(db, "scp/" + scpId), newData);
      alert("SCP –æ–±–Ω–æ–≤–ª—ë–Ω!");
      location.reload();
    }

    // ---------- –£–¥–∞–ª–µ–Ω–∏–µ ----------
    async function deleteSCP() {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å SCP?")) return;
      await remove(ref(db, "scp/" + scpId));
      alert("SCP —É–¥–∞–ª—ë–Ω!");
      window.location.href = "index.html";
    }

    loadSCP();

    // –≥–ª–æ–±–∞–ª
    window.showEdit = showEdit;
    window.cancelEdit = cancelEdit;
    window.saveEdit = saveEdit;
    window.deleteSCP = deleteSCP;
  </script>
</body>
</html>
