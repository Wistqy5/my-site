<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCP Foundation — Просмотр</title>
  <style>
    body { background:#0d0d0d; color:#eee; font-family:Segoe UI, Arial, sans-serif; margin:0; padding:24px; }
    .panel { background:#1c1c1c; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.4); }
    h1 { margin:0 0 6px; }
    .muted { color:#aaa; margin-bottom:12px; }
    button { margin:6px 6px 0 0; padding:8px 12px; border:0; border-radius:8px; background:#c62828; color:#fff; cursor:pointer; font-weight:600; }
    button:hover { background:#e53935; }
    .ghost { background:#444; }
    .ghost:hover { background:#666; }
    textarea { width:100%; height:180px; display:none; background:#111; color:#eee; border:1px solid #333; border-radius:8px; padding:10px; }
    pre { white-space:pre-wrap; word-wrap:break-word; }
  </style>
</head>
<body>
  <div class="panel">
    <h1 id="scpTitle"></h1>
    <div class="muted" id="meta"></div>
    <div id="scpContent" style="margin-top:10px;"><pre id="textView"></pre></div>

    <textarea id="editText"></textarea><br>
    <div id="controls" style="display:none;">
      <button id="editToggle" class="ghost" onclick="toggleEdit()">Редактировать</button>
      <button id="saveEditBtn" onclick="saveEdit()" style="display:none;">Сохранить</button>
      <button id="deleteBtn" onclick="deleteSCP()" style="display:none;">Удалить</button>
    </div>

    <button class="ghost" onclick="window.location.href='home.html'">Назад</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7mvVHeOg48A8HZknsdidnZlKQV6BJLIo",
      authDomain: "scp-foundation-45b20.firebaseapp.com",
      databaseURL: "https://scp-foundation-45b20-default-rtdb.firebaseio.com/",
      projectId: "scp-foundation-45b20",
      storageBucket: "scp-foundation-45b20.appspot.com",
      messagingSenderId: "383272466518",
      appId: "1:383272466518:web:3225b8911a56c9d769e3f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Текущий пользователь
    const user = JSON.parse(localStorage.getItem("user") || "null");
    if (!user) window.location.href = "index.html";

    // Параметр id
    const scpId = new URLSearchParams(window.location.search).get("id");

    let current = null;
    let canEdit = false;   // вычислим после загрузки

    async function loadSCP() {
      const snap = await get(ref(db, "scp/" + scpId));
      if (!snap.exists()) {
        document.getElementById("textView").textContent = "Такого SCP не существует";
        return;
      }

      current = snap.val(); // { title, requiredLevel, content, author }
      document.getElementById("scpTitle").textContent = current.title;
      document.getElementById("meta").textContent =
        `Автор: ${current.author || "неизвестно"} | Требуемый уровень: ${current.requiredLevel}`;

      // Проверка доступа на чтение
      if (Number(user.level) >= Number(current.requiredLevel)) {
        document.getElementById("textView").textContent = current.content || "";
      } else {
        document.getElementById("textView").textContent = "ACCESS DENIED";
      }

      // Проверка прав на редактирование/удаление
      canEdit = (current.author === user.nick && Number(user.level) >= 3) || Number(user.level) >= 4;
      document.getElementById("controls").style.display = canEdit ? "block" : "none";
      document.getElementById("deleteBtn").style.display = Number(user.level) >= 4 ? "inline-block" : "none";
      if (canEdit) document.getElementById("editText").value = current.content || "";
    }

    window.toggleEdit = () => {
      if (!canEdit) return;
      const area = document.getElementById("editText");
      const save = document.getElementById("saveEditBtn");
      const viewing = area.style.display !== "block";
      area.style.display = viewing ? "block" : "none";
      save.style.display = viewing ? "inline-block" : "none";
    };

    window.saveEdit = async () => {
      if (!canEdit) return;
      const newText = document.getElementById("editText").value;
      await update(ref(db, "scp/" + scpId), { content: newText });
      alert("Изменения сохранены");
      document.getElementById("textView").textContent = newText;
      toggleEdit();
    };

    window.deleteSCP = async () => {
      if (Number(user.level) < 4) return;
      if (!confirm("Удалить SCP?")) return;
      await remove(ref(db, "scp/" + scpId));
      alert("Удалено");
      window.location.href = "home.html";
    };

    loadSCP();
  </script>
</body>
</html>
